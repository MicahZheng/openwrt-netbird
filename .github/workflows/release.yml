name: release

on:
  repository_dispatch:
    types: [release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Netbird version (e.g. 0.50.3), leave blank for latest'
        required: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      update: ${{ steps.set-update.outputs.update }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init Env
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: Determine Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(curl -sL https://api.github.com/repos/netbirdio/netbird/releases/latest | jq -r .tag_name | sed 's/^v//')
          fi
          echo "PKG_VERSION=${VERSION}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update Makefile
        run: |
          PKG_HASH=$(curl -sL https://codeload.github.com/netbirdio/netbird/tar.gz/v${PKG_VERSION} | sha256sum | cut -d ' ' -f1)
          sed -i "s/^PKG_VERSION.*/PKG_VERSION:=${PKG_VERSION}/" netbird/Makefile
          sed -i "s/^PKG_HASH.*/PKG_HASH:=${PKG_HASH}/" netbird/Makefile

      - name: Commit Update if Needed
        id: set-update
        run: |
          git pull
          if git status -s | grep -q netbird/Makefile; then
            git add netbird/Makefile
            git commit -m "Update netbird to ${PKG_VERSION} $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "update=true" >> $GITHUB_ENV
            echo "update=true" >> $GITHUB_OUTPUT
          else
            echo "update=false" >> $GITHUB_ENV
            echo "update=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build - ${{ matrix.target.arch }}
    needs: check
    if: needs.check.outputs.update == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - arch: "aarch64_generic"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - arch: "arm_cortex-a9"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/bcm53xx/generic/openwrt-sdk-24.10.4-bcm53xx-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst"
          - arch: "arm_cortex-a15"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/ipq806x/generic/openwrt-sdk-24.10.4-ipq806x-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst"
          - arch: "aarch64_cortex-a53"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/bcm27xx/bcm2710/openwrt-sdk-24.10.4-bcm27xx-bcm2710_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - arch: "aarch64_cortex-a72"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/bcm27xx/bcm2711/openwrt-sdk-24.10.4-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - arch: "arm_cortex-a7_neon-vfpv4"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/ipq40xx/generic/openwrt-sdk-24.10.4-ipq40xx-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst"
          - arch: "x86_64"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - arch: "i386_pentium4"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/x86/generic/openwrt-sdk-24.10.4-x86-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - arch: "mips_74kc"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/ath79/generic/openwrt-sdk-24.10.4-ath79-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - arch: "mipsel_24kc"
            sdk: "https://downloads.openwrt.org/releases/24.10.4/targets/ramips/mt7621/openwrt-sdk-24.10.4-ramips-mt7621_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Checkout Pull latest changes to ensure correct Makefile version
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git pull origin main

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools \
          libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev python3-setuptools npm

      - name: Install OpenWrt SDK
        run: |
          wget ${{ matrix.target.sdk }} -O openwrt-sdk.tar.zst
          tar -xf openwrt-sdk.tar.zst
          mv -f openwrt-sdk-* openwrt-sdk

      - name: Build Package
        run: |
          set -e

          cd openwrt-sdk
          cp -rf ../netbird ./package/
          echo "src-link netbird $(pwd)/package" >> feeds.conf.default

          # Git 网络稳定性配置（防止 RPC failed / early EOF）
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999

          # feeds update：浅克隆 + 自动重试
          for i in 1 2 3; do
            echo "feeds update attempt $i"
            GIT_TERMINAL_PROMPT=0 ./scripts/feeds update -a && break
            sleep 10
          done

          ./scripts/feeds install -a

          rm -rf ./feeds/packages/lang/golang
          git clone --depth=1 https://github.com/sbwml/packages_lang_golang -b 25.x ./feeds/packages/lang/golang

          make defconfig
          make package/netbird/compile V=s CONFIG_NETBIRD_COMPRESS_UPX=y
          mkdir -p packed
          find bin/ -type f -name '*netbird*' -exec mv -t packed {} +
      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: netbird-${{ matrix.target.arch }}
          path: openwrt-sdk/packed/*.ipk
          if-no-files-found: error
  release:
    name: Publish Release
    needs: [check, build]
    if: needs.check.outputs.update == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.check.outputs.version }}
          files: dist/**/*.ipk
